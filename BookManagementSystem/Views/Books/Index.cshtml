@model dotNetBasic.ViewModels.BooksViewModel

<h2 class="mb-4">Book Library</h2>

<div id="highlightedBooks">
    @await Html.PartialAsync("_HighlightedBooks", Model.HighlightedBooks)
</div>

<hr />

<div class="row mb-3 align-items-center">
    <div class="col-md-4">
        <select id="genreFilter" class="form-select">
            <option value="">All Genres</option>
        </select>
    </div>
    <div class="col-md-4 text-center">
        <h6>Total Books: <span id="totalBooks">@Model.TotalBooks</span></h6>
    </div>
    <div class="col-md-4 text-end">
        <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#bookModal">
            Create Book
        </button>
    </div>
</div>

<div id="booksContainer">
    @await Html.PartialAsync("_BooksList", Model.AllBooks)
</div>


<div class="modal fade" id="bookModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="bookForm">
                <div class="modal-header">
                    <h5 class="modal-title">Create Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="BookId" name="Id" />
                    <div class="mb-3">
                        <label>Title</label>
                        <input type="text" id="Title" name="Title" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Author</label>
                        <input type="text" id="Author" name="Author" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Genre</label>
                        <input type="text" id="Genre" name="Genre" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label>Description</label>
                        <textarea id="Description" name="Description" class="form-control"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
        $(function () {

            function loadGenres() {
                $.ajax({
                    type: "GET",
                    url: "/GetGenres",
                    success: function (genres) {
                        const genreSelect = $("#genreFilter");
                        genres.forEach(genre => {
                            genreSelect.append(`<option value="${genre}">${genre}</option>`);
                        });
                    },
                    error: function (xhr) {
                        console.error("Error loading genres:", xhr);
                    }
                });
            }

            loadGenres();

            $("#genreFilter").change(function () {
                const genre = $(this).val();

                $.ajax({
                    type: "GET",
                    url: `/GetByGenre/${encodeURIComponent(genre)}`,
                    success: function (books) {
                        if (!books || books.length === 0) {
                            $("#booksContainer").html("<p class='text-muted'>No books found for this genre.</p>");
                            $("#totalBooks").text("0");
                            return;
                        }

                        let booksHtml = "";
                        books.forEach(book => {
                            booksHtml += `
                                <div class="card mb-2 shadow-sm" data-book-id="${book.id}">
                                    <div class="card-body">
                                        <h6 class="card-title">${book.title || 'N/A'}</h6>
                                        <p class="mb-1 text-muted">${book.author || 'N/A'}</p>
                                        <small>${book.genre || 'N/A'}</small>

                                        <div class="float-end">
                                            <button class="btn btn-sm btn-outline-primary edit-book" data-id="${book.id}" title="Edit">‚úè</button>
                                            <button class="btn btn-sm btn-outline-danger delete-book" data-id="${book.id}" title="Delete">üóëÔ∏è</button>
                                            <a href="/Details/${book.id}" class="btn btn-sm btn-outline-dark" title="View">View</a>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        $("#booksContainer").html(booksHtml);
                        $("#totalBooks").text(books.length);
                    },
                    error: function (xhr) {
                        console.error("Error:", xhr);
                        $("#booksContainer").html("<p class='text-danger'>Error loading books. Please try again.</p>");
                    }
                });
            });

            $("#bookForm").submit(function (e) {
                e.preventDefault();

                const id = $("#BookId").val();

                const bookData = {
                    Id: id ? parseInt(id) : 0,
                    Title: $("#Title").val(),
                    Author: $("#Author").val(),
                    Genre: $("#Genre").val(),
                    Description: $("#Description").val()
                };

                const isEdit = id && id !== "";

                $.ajax({
                    type: isEdit ? "PUT" : "POST",
                    url: isEdit ? "/Update" : "/Create",
                    contentType: "application/json",
                    data: JSON.stringify(bookData),
                    success: function () {
                        $("#bookModal").modal("hide");
                        location.reload();
                    },
                    error: function (xhr) {
                        alert("Error: " + (xhr.responseText || "Unknown error"));
                    }
                });
            });

            $(document).on("click", ".edit-book", function () {
                const id = $(this).data("id");

                $.get(`/GetById/${id}`, function (book) {
                    $("#BookId").val(book.id);
                    $("#Title").val(book.title);
                    $("#Author").val(book.author);
                    $("#Genre").val(book.genre);
                    $("#Description").val(book.description);

                    $("#bookModal").modal("show");
                });
            });

            $(document).on("click", ".delete-book", function () {
                const id = $(this).data("id");

                if (!confirm("Are you sure you want to delete this book?")) return;

                $.ajax({
                    type: "DELETE",
                    url: `/Delete/${id}`,
                    success: function () {
                        location.reload();
                    },
                    error: function (xhr) {
                        alert("Error: " + (xhr.responseText || "Unknown error"));
                    }
                });
            });

            $("#bookModal").on("show.bs.modal", function () {
                if ($("#BookId").val()) {
                    $("#bookModal .modal-title").text("Edit Book");
                    return;
                }
                $("#bookForm")[0].reset();
                $("#bookModal .modal-title").text("Create Book");
            });

        });
    </script>
}

